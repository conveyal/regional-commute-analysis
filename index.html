<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="//api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/dc/1.7.1/dc.css">
    <style>
      .dc-table-group {
        display: none;
      }

      #map {
        height: 400px;
        width: 100%;
        border-bottom: 4px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div id="viz" style="display:none;">
      <div id="map"></div>
      <div class="container">
        <div class="row">
          <div id="data-count" class="col-sm-12">
            <h4><strong class="filter-count"></strong> selected out of <strong class="total-count"></strong> records</h4>
          </div>
          <div id="mode-pie-chart" class="col-sm-2">
            <strong>Mode</strong>
            <a class="reset" href="javascript:charts.mode.filterAll();dc.redrawAll();" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div id="score-chart" class="col-sm-3">
          <strong>Score</strong>
            <span class="filter"></span>
            <a class="reset" href="javascript:charts.score.filterAll();dc.redrawAll();" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div id="time-chart" class="col-sm-3">
            <strong>Time</strong>
            <span class="filter"></span>
            <a class="reset" href="javascript:charts.time.filterAll();dc.redrawAll();" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div id="speed-chart" class="col-sm-3">
            <strong>Speed (MPH)</strong>
            <span class="filter"></span>
            <a class="reset" href="javascript:charts.speed.filterAll();dc.redrawAll();" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div class="col-sm-12">
            <table id="data-table" class="table table-condensed table-hover"></table>
          </div>
        </div>
      </div>
    </div>

    <script src="//api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js"></script>
    <script src="/build/build.js"></script>
    <script>
      var crossfilter = require('crossfilter').crossfilter;
      var d3 = require('d3');
      var haversine = require('haversine');
      var ProfileScorer = require('otp-profile-score');
      var Spinner = require('spin');
    </script>
    <script src="//d3js.org/d3.hexbin.v0.min.js"></script>
    <script src="/hexbin.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dc/1.7.1/dc.js"></script>
    <script>
      // constants
      var height = 150, width = 310, margin = { top: 0, right: 10, bottom: 20, left: 40 };

      // globals
      var blocks, charts = {}, data, map, options;

      // Scorer to be updated on the fly
      var scorer = new ProfileScorer();
      scorer.scaleCalories = d3.scale.sqrt().domain([0, 100, 150]).range([0, 1, 0]).exponent(2);

      // Show spinner cause loading takes awhile
      var spinner = new Spinner().spin();
      document.body.appendChild(spinner.el);

      // Load json
      d3.json('./data/profiles.json', function(err, json) {
        if (err) return window.alert(err);

        // Split it up so we can rescore and process again
        data = scoreOptions(json);

        // Show viz & stop spinner
        document.getElementById('viz').style.display = 'block';
        spinner.stop();

        // After displaying, setup the map
        map = L.mapbox.map('map', 'conveyal.gepida3i', {
          touchZoom: false,
          scrollWheelZoom: false
        }).setView([38.8399874, -77.0911667], 9);

        // Crossfilterize
        processOptions(data);

        // Generate Hexbins
        map.on('viewreset', function() { generateHexbins(map, dimensions); });

        // Attach to dc.js renderLet
        charts.mode.renderlet(function(c) {
          dc.events.trigger(function() {
            // Rescore all the records
            rescore(data);

            // Redraw the hexbins
            generateHexbins(map, dimensions);
          });
        });
      });

      function processOptions(data) {
        options = crossfilter(data);
        dimensions = getDimensions(options);

        charts.table = dc.dataTable('#data-table')
          .columns(getTableColumns())
          .dimension(dimensions.time)
          .group(function(d) {
            return '';
          })
          .sortBy(function(d) {
            return d.time;
          })
          .size(10);

        charts.mode = dc.pieChart('#mode-pie-chart')
          .height(height)
          .dimension(dimensions.mode)
          .group(dimensions.mode.group());

        charts.score = dc.lineChart('#score-chart')
          .height(height)
          .width(width)
          .margins(margin)
          .elasticY(true)
          .round(Math.round)
          .x(d3.scale.linear().domain([20, 400]))
          .dimension(dimensions.score)
          .group(dimensions.score.group(function(d) {
            return d === Infinity
              ? 500
              : Math.round(d / 2) * 2;
          }));

        charts.time = dc.lineChart('#time-chart')
          .height(height)
          .width(width)
          .margins(margin)
          .elasticY(true)
          .round(Math.round)
          .x(d3.scale.linear().domain([0, 205]))
          .dimension(dimensions.time)
          .group(dimensions.time.group(function(d) { return Math.round(d / 2) * 2; }));

        charts.speed = dc.barChart('#speed-chart')
          .height(height)
          .width(width)
          .margins(margin)
          .elasticY(true)
          .round(Math.round)
          .x(d3.scale.linear().domain([0, 50]))
          .dimension(dimensions.speed)
          .group(dimensions.speed.group(function(d) {
            return d === Infinity
              ? 25
              : Math.round(d);
          }));

        charts.count = dc.dataCount('#data-count')
          .dimension(options)
          .group(options.groupAll());

        dc.renderAll();
      }

      function getDimensions(o) {
        return {
          origin: o.dimension(function(d) { return d.journey[0][0]; }),
          speed: o.dimension(function(d) { return d.totalDistance / (d.time / 60); }),
          mode: o.dimension(function(d) { return d.mode; }),
          score: o.dimension(function(d) { return d.score; }),
          time: o.dimension(function(d) { return d.time; })
        };
      }

      function getTableColumns() {
        return [
          function(d) { return d.mode; },
          function(d) { return d.score.toFixed(1); },
          function(d) { return '$' + d.totalCost; },
          function(d) { return d.totalDistance.toFixed(1) + ' mi'; },
          function(d) { return Math.round(d.time) + ' min'; }
        ];
      }

      function rescore(d) {
        for (var i = 0; i < d.length; i++) d[i] = scorer.processOption(d[i]);
      }

      function scoreOptions(d) {
        var data = [];
        for (var i = 0; i < d.length; i++) {
          for (var j = 0; j < d[i].options.length; j++) {
            var option = scorer.processOption(d[i].options[j]);
            option.journey = d[i].journey;
            option.journey[0].origin = 1;
            option.journey[1].origin = -1;

            if (option.totalDistance === 0) {
              option.totalDistance = haversine(
                option.journey[0][1], option.journey[0][0],
                option.journey[1][1], option.journey[1][0],
                true); // in miles
            }

            data.push(option);
          }
        }
        return data;
      }

      var _polys = [];
      function generateHexbins(map, dimensions) {
        _polys.forEach(map.removeLayer.bind(map));

        var bounds = map.getBounds();
        var $map = document.getElementById('map');
        var rmax = (bounds.getNorth() - bounds.getSouth()) / 30;

        // Allllll
        var data = dimensions.origin.top(Infinity);

        // Generate hexbins
        var hexbins = hexbin(data.map(function(d) {
          return d.journey[0];
        }).concat(data.map(function(d) {
          return d.journey[1];
        })), {
          caccessor: function(b) {
            return b.score;
          },
          cscale: function(bs) {
            var min = Infinity, max = -Infinity;
            bs.forEach(function(b) {
              b.score = 0;
              for (var i = 0; i < b.length; i++) b.score += b[i].origin;
              if (b.score < min) min = b.score;
              if (b.score > max) max = b.score;
            });
            return d3.scale.sqrt()
              .domain([ min, max ])
              .range(['#428bca', '#d9534f']);
          },
          height: $map.clientHeight,
          rmax: rmax,
          width: $map.clientWidth
        });

        _polys = hexbins.map(function(d) {
          return L.polygon(d.coords, {
            stroke: true,
            weight: 1,
            color: '#e5e5e5',
            fill: true,
            fillOpacity: 0.75,
            fillColor: d.color
          }).addTo(map);
        });
      }
    </script>
  </body>
</html>